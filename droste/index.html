<!DOCTYPE html>
<html>
<head>
<title>The Droste effect</title>
<meta charset="UTF-8">
<link rel="stylesheet" href="style.css">
<script type="text/javascript" src="Cindy.js"></script>
<script type="text/javascript" src="CindyGL.js"></script>

<script id="csinit" type="text/x-cindyscript">
imagemode = true;
image = "image";

reset() :=(
  Z = [[1,0],[0,1]];
  M = [[1,0],[0,1]];
  azoom = 0;

  dragging = false;
  m0 = [0,1];

  ptselect = true;
  tolerance = 0.2;

  color = [0,1,0];

  zoom = exp(0);
  doffset = 0;
  goffset = 0;
  lasttick = seconds();
);
reset();

project2square(z) :=  z/max(|re(z)|,|im(z)|);

project2rectangle(z) := (
  p = complex2sphere(1e3*z); //works only for points that are outside of the rectangle
  forall(1..4, j,
    v = p-scenter;
    //if(((p*mid_j)/(v*mid_j))>0, 
    if((p*mid_j)>0, 
      p = p - ((p*mid_j)/(v*mid_j))*v;
    );
  );
  sphere2complex(p)
);


f(z) := (z);

//0 -> a, oo -> b, 1 -> c
moebhelp(a, b, c) := (
  alpha = (c-b)/(a-b);
  beta = (c-a)/(b-a);
  [[alpha*a, beta*b],[alpha, beta]]
);

gen( w2) := (
  moebhelp(w0, w1, w2)*inverse(moebhelp(v0, v1, v2))
);

anti(z) := (-1/conjugate(z));

complex2sphere(z) := (
  l2 = |z|*|z|;
  (2*re(z)/(1+l2), 2*im(z)/(1+l2), (-1+l2)/(1+l2))
);

sphere2complex(s) := (
  s = s/|s|;
  (s_1 + i*s_2)/(1-s_3)
);

latlon2complex(latlon) := (
  //phi = latlon_1;
  //alpha = phi/2+pi/4
  tan(latlon_1/2+pi/4)*(cos(latlon_2) + i *sin(latlon_2))
);


screen2complex(M, pixel) := (
  //( pixel_1]))
  ( (exp(azoom)*(pixel_1 + i*pixel_2)))
);

complex2screen(M, z) := (
  gauss(( z)/exp(azoom))
);

complex2latlon(z) := (
  //lambda = arctan2(re(z), im(z));
  //alpha = arctan(|z|);
  //2*alpha + pi/2-phi = pi
  //phi = 2*alpha - pi/2;
  (2*arctan(|z|)-pi/2, arctan2(re(z), im(z)))
);

readcamera(z) := (
  imagergb([-1,-1/2], [1,-1/2], image, (re(z), im(z)), interpolate->true);
);


setcenter() := (
  Z = inverse(M);
);

onScroll(delta) := (
  errc(delta);
  azoom = azoom-delta/1000
);



greenval(c):=(
  //|c,color|+|c/(c*(1,1,1)), color/(color*(1,1,1))|<tolerance
  //|c,color|+|c_3,color_3|<tolerance
  
  min(max(((-c_1-c_3+2*c_2)-(-color_1-color_3+2*color_2))/tolerance+1.5,0),1)
  //min(max((c * color - color*color + 1),0),1)
)
</script>

<script id="cskeydown" type="text/x-cindyscript">
print("pressed key" + keycode());
if(keycode()==13,  //ENTER
  ptselect = false;
  
  p0 = 0;
  p1 = center;

  a1 = sphere2complex(cross(complex2sphere(p0), complex2sphere(p1)));
  a2 = sphere2complex(-cross(complex2sphere(p0), complex2sphere(p1)));

  T = genmoeb(
    p1, a1, a2,
    p0, a1, a2
  );
  
    f(z) := (
      z = ( z-center);    
      z = z/exp(4*zoom+mod(goffset,zoom)); //zoom in
      run = true;
      col = [0,0,0];
      gv = 1;
      repeat(16, //and walk out as long as required
        if(run,
          gc = readcamera(((z+center)));
          col = (1-gv)*col + gv*gc;//use old gv
          gv = greenval(gc);
          if(gv<.1, run = false);
          z = z*exp(zoom);
        );
      );
      col;
    );

);
</script>
<script id="csmousedown" type="text/x-cindyscript">
if(ptselect,
  //ptselect = false;
  center = (screen2complex(M, mouse()));
  color = readcamera((center));
  errc(color);
);
M0 = M;
m0 = mouse();
p0 = screen2complex(M, m0);

dragging = true;
</script>

<script id="csmouseup" type="text/x-cindyscript">
dragging = false;
</script>

<script id="csdraw" type="text/x-cindyscript">
now = seconds();
goffset = goffset+doffset*(now-lasttick);

lasttick = now;


if(ptselect,f(z):=z;);

if (imagemode % imageready(video),
  //draw image (A, B, video);
  
  if(ptselect,
    colorplot(
      z = screen2complex(M, #);
      z = f(z);
      c = readcamera((z));
      //if(ptselect & islikecolor(c), [1,0,0], c)
      gv = greenval(c);
      gv*[1,0,0]+(1-gv)*c;
    ),
    colorplot(
      z = screen2complex(M, #);
      f(z);
    )
  );
);
if(ptselect,

  drawtext((0,0), "select the tolerance and center of the greenbox 
  for the Droste-area and press ENTER when you are done", size->30, align->"mid");

  ,
  
);

</script>


<script id="csondrop" type="text/x-cindyscript">
  dropped = dropped();
  dump(dropped);
  if (!isundefined(dropped_1_1), image = dropped_1_1; dump(image););
  
</script>
</head>
<body>
  <h1>The Droste effect</h1>
  <p>
    The so called <a href="https://en.wikipedia.org/wiki/Droste_effect">"Droste effect"</a> refers to a picture that contains the picture itself. Within this embedded picture, the original picture occurs recursively. Advertisements often utilize this effect.
  </p>
  <p>
It gets more exciting if the replicated picture is twisted as in M.C. Escher's famous lithograph <a href="https://en.wikipedia.org/wiki/Print_Gallery_(M._C._Escher)">"Print Gallery"</a>. In this artwork, a visitor sees a picture that ultimately contains himself.
In 2002 the Dutch mathematicians Hendrik Lenstra and Bart de Smit <a href="http://escherdroste.math.leidenuniv.nl/">investigated the image and laid a mathematical foundation</a> for the twisted Droste effect.
  <p>
    This website applies the Droste Effect in real-time to either uploaded images, the webcam stream (using the <a href="http://cindyjs.org">CindyJS</a> software together with <a href="https://cindyjs.org/extras/2016-icms/ICMS_CindyGL_Extended_Abstract.pdf">CindyGL</a>).
  </p>
  <p>
    <a href="https://arxiv.org/abs/1605.01396">In their article,</a> Saul Schleimer and Henry Segerman demonstrated how the (twisted) Droste effect could be applied to spherical images by utilizing the complex exponential, logarithm, and MÃ¶bius transformations.
    If you have a spherical camera (such as the Ricoh Theta), you can also try out this effect in real-time on this website.
  </p>

  
  <div class="options">
    <a id="image">Use static image</a>
    <a id="webcam">Try my webcam</a>
    <a id="spherical">I want to use my spherical webcam</a>
  </div>
  <p>
  <div id="outer">
    <div id="CSCanvas" onwheel="cdy.evokeCS('onScroll(' + event.wheelDelta + ')');"></div>
  </div>
  <script type="text/javascript">
  var cdy = CindyJS({
    ports: [{id: "CSCanvas", transform:[{visibleRect:[-1,-1,1,1]}]}],
    scripts: "cs*",
    language: "en",
    autoplay: true,
    images: {image: "image.jpg"},
    defaultAppearance: {
    },
    geometry: [
      //{name:"A", type:"Free", pos:[0,0], visible:true},
    ],
    use: ["CindyGL"]
  });
  </script>
  
  <div id="overlay">
  <select id="sel" style="width:8em;" size="2">
    <option value="      z = ( z-center);    
          z = z/exp(4*zoom+mod(goffset,zoom)); //zoom in
          run = true;
          col = [0,0,0];
          gv = 1;
          repeat(16, //and walk out as long as required
            if(run,
              gc = readcamera(((z+center)));
              col = (1-gv)*col + gv*gc;//use old gv
              gv = greenval(gc);
              if(gv<.1, run = false);
              z = z*exp(zoom);
            );
          );
          col;
  " selected>Droste</option>
    <option value="
    z = ( z-center);
    modulus = (zoom+2*pi*i);
    alpha = (2*pi*i)/modulus;
    z = exp(log(z)/alpha);
    z = z/exp(4*zoom+mod(goffset,zoom)); //zoom in
    run = true;
    col = [0,0,0];
    gv = 1;
    repeat(16, //and walk out as long as required
      if(run,
        gc = readcamera(((z+center)));
        col = (1-gv)*col + gv*gc;//use old gv
        gv = greenval(gc);
        if(gv<.1, run = false);
        z = z*exp(zoom);
      );
    );
    col;
  ">twisted Droste</option>
  </select>
</p>
<p>
  zoom: <input type="range" id="zoom" min="-1.5" max="1.5" step="0.01" value="0"></input>
  speed: <input type="range" id="doffset" min="-1.1" max="1.1" step="0.1" value="0"></input>
  tolerance: <input type="range" id="tolerance" min="0.0001" max="0.5" step="0.001" value="0.2"></input>
</p>

<!--<p><button onclick="cdy.evokeCS('setcenter()')">set current center to 0</button></p>-->
  </p>
  <a class="mybutton" id="fs">Enter Fullscreen</a>
  <p>
  </div>
  <div class="author">  
    Author: <a href="https://www-m10.ma.tum.de/bin/view/Lehrstuhl/AaronMontag">Aaron Montag</a>
  </div>
  </p>
  
  <script type="text/javascript">
  document.getElementById("sel").addEventListener('change', function(event) {
  //  document.getElementById('inp').value = this.value;
    cdy.evokeCS('f(z) := (' + this.value + ');');
  }, false);
  
  document.getElementById("zoom").addEventListener('mousemove', function(event) {
  //  document.getElementById('inp').value = this.value;
    cdy.evokeCS('zoom = exp(' + this.value + ');');
  }, false);
  
  document.getElementById("doffset").addEventListener('mousemove', function(event) {
  //  document.getElementById('inp').value = this.value;
    cdy.evokeCS('doffset = (' + this.value + ');');
  }, false);
  
  document.getElementById("tolerance").addEventListener('mousemove', function(event) {
  //  document.getElementById('inp').value = this.value;
    cdy.evokeCS('tolerance = (' + this.value + ');');
  }, false);
  
  document.getElementById("webcam").onclick = function() {
    cdy.evokeCS(`
      video = camera video();
      imagemode = false;
      readcamera(z) := (
        imagergb([-1,-1/2], [1,-1/2], video, (re(z), im(z)), interpolate->true);
      );
      reset();
    `);
  };
  
  document.getElementById("image").onclick = function() {
    cdy.evokeCS(`
      imagemode = true;
      readcamera(z) := (
        imagergb([-1,-1/2], [1,-1/2], image, (re(z), im(z)), interpolate->true);
      );
      reset();
    `);
  };
  
  var btn = document.getElementById("fs");
  var div = document.getElementById("CSCanvas");
  btn.onclick = function() {
    (div.requestFullscreen ||
     div.webkitRequestFullscreen ||
     div.mozRequestFullScreen ||
     div.msRequestFullscreen ||
     function(){}).call(div);
  };
  
  </script>
</body>
</html>
